<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mini Chat Flask-SocketIO</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md bg-white shadow-lg rounded-2xl overflow-hidden">
    <div class="bg-indigo-600 text-white p-4 text-center">
      <h2 class="text-xl font-semibold">ðŸ’¬ Mini Chat (Invitados)</h2>
    </div>

    <div class="p-4 flex gap-2 items-center" id="login">
      <input id="username" placeholder="Tu nombre de invitado"
        class="flex-1 px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
      <button onclick="joinChat()" 
        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
        Entrar
      </button>
    </div>

    <div id="chat" class="h-72 overflow-y-auto px-4 py-3 space-y-2 bg-gray-50"></div>
    <div id="typing" class="px-4 text-sm text-gray-500 h-5"></div>
    <form id="form" onsubmit="return sendMessage();" class="p-4 flex gap-2 hidden">
      <input id="msg" autocomplete="off" placeholder="Escribe un mensaje..."
        class="flex-1 px-3 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
      <button 
        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
        Enviar
      </button>
    </form>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    let socket;
    let username = '';
    function joinChat() {
      username = document.getElementById('username').value.trim();
      if (!username) { alert('Ingresa un nombre.'); return; }
      socket = io();
      socket.emit('join', { username });

      document.getElementById('form').classList.remove('hidden');
      document.getElementById('username').disabled = true;
      document.querySelector('#login button')?.setAttribute('disabled', 'true');
      document.querySelector('#login button')?.classList.add("opacity-50", "cursor-not-allowed");

      const chat = document.getElementById('chat');
      chat.innerHTML = '';
      socket.on('message', function(data) {
        const msgClass = data.username === username 
          ? "bg-indigo-600 text-white self-end" 
          : "bg-gray-200 text-gray-900 self-start";

        const bubble = `<div class="px-3 py-2 rounded-xl max-w-[80%] ${msgClass}">
                          <span class="text-sm font-semibold">${data.username}:</span> 
                          <span>${data.msg}</span>
                        </div>`;
        chat.innerHTML += `<div class="flex ${data.username === username ? "justify-end" : "justify-start"}">${bubble}</div>`;
        chat.scrollTop = chat.scrollHeight;
      });

      // Evento typing
      socket.on('typing', function(data) {
        const typingDiv = document.getElementById('typing');
        if (data.username && data.username !== username) {
          typingDiv.textContent = `${data.username} estÃ¡ escribiendo...`;
        } else {
          typingDiv.textContent = '';
        }
      });
    }
    function sendMessage() {
      const msg = document.getElementById('msg').value.trim();
      if (msg && socket) {
        socket.emit('message', { username, msg });
        document.getElementById('msg').value = '';
        socket.emit('typing', { username: username, typing: false });
      }
      return false;
    }

    document.addEventListener('DOMContentLoaded', function() {
      const msgInput = document.getElementById('msg');
      let typingTimeout;
      if (msgInput) {
        msgInput.addEventListener('input', function() {
          if (socket && username) {
            socket.emit('typing', { username: username, typing: true });
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
              socket.emit('typing', { username: username, typing: false });
            }, 1200);
          }
        });
      }
    });
  </script>
</body>
</html>
